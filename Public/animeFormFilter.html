<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">


    <title>OG Netflix Anime Entries</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="formStyleSheet.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">

            <button class="navbar-toggler" id="hamburgerButton" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-header">

                    <a class="navbar-brand" title ="brand" href="#"></a>

                </div>

                <ul class="nav navbar-nav">


                    <li class="nav-item"><a class="nav-link" href="AnimeForm.html">Enter Anime Form</a></li>
                    <li class="nav-item"><a class="nav-link" href="animeFormFilter.html">Anime Entry Data</a></li>


            </div>


        </div>
    </nav>

    <div class="container">
        <div id="introScreen">
            <h1>N</h1>
        </div>




        <h1>Netflix Original Anime Entries</h1>


        <div id="filterSection" class="container">

            <div class="row">
                <div class="col-md-12" id="filterButtonSection">
                    <button id="filterButton">Filter</button>
                    <button id="sortByInput">Sort</button>
                    <button id="clearButton">Clear</button>
                </div>

            </div>
            <div class="row" id="filterTextInputs">
                <div class="col-md-12">
                    <label for="filterTitle">Filter by:</label>
                    <input type="text" id="filterTitle" placeholder="Enter Anime Title">

                    <input type="text" id="filterDate" placeholder="Enter Release Year">

                    <input type="text" id="filterPublisher" placeholder="Enter Publisher Name">

                    <select id="filterStars" title="Filter by Stars">
                        <option value="">Stars</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                    <select id="filterStyle" title="Filter by Style">
                        <option value="">All Styles</option>
                        <option value="Hybrid">Hybrid</option>
                        <option value="3D">3D</option>
                        <option value="2D">2D</option>
                    </select>
                    <select id="filterRating" title="Filter by Rating">
                        <option value="">All Ratings</option>
                        <option value="TV-MA">TV-MA</option>
                        <option value="TV-14">TV-14</option>
                        <option value="TV-PG">TV-PG</option>
                        <option value="TV-G">TV-G</option>
                        <option value="TV-Y7">TV-Y7</option>
                    </select>
                    <label for="limitRecords">Limit Records:</label>
                    <select id="limitRecords" title="Limit Records">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="row" id="sortSection">
                <div class="col-md-12">
                    <label for="sortBy">Sort By:</label>
                    <select id="sortBy">
                        <option value="title">Title</option>
                        <option value="date">Date</option>
                        <option value="publisher_name">Publisher</option>
                        <option value="rating">Rating</option>
                        <option value="style">Style</option>
                        <option value="num_of_seasons">Seasons</option>
                        <option value="stars">Stars</option>
                    </select>

            

                </div>

            </div>


            <table id="animeTable" class="responsive-table  table table-striped rounded-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Rating</th>
                        <th>Image</th>
                        <th>Style</th>
                        <th>Summary</th>
                        <th>Seasons</th>
                        <th>Stars</th>
                        <th>Publisher Name</th>
                        <th>Publisher Country</th>
                        <th>Publisher City</th>
                        <th>Actions</th>

                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be added here -->
                </tbody>
            </table>
            <!--</form> -->
        </div>
    </div>

    <!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ Edit Anime Modal -->
<div class="modal fade" id="editAnimeModal" tabindex="-1" aria-labelledby="editAnimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div id="editAnimeForm" class="modal-body row g-3 p-3">
          <div class="modal-header">
   
            <h4 class="modal-title" id="editAnimeModalLabel">Edit Anime Entry</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div id="banner" class="col-12"></div>
          <div class="modal-body row g-3 p-3">
            <input type="hidden" id="editAnimeId">
  
            <div class="col-md-6">
             <h5>Title</h5>
              <input name="anime_title" type="text" id="editTitle" class="form-control" required>
            </div>
  
            <div class="col-md-6">
<h5>Date</h5>
              <input name="date" type="date" id="editDate" class="form-control" required>
            </div>

  <div class="col-md-12">
<h5>Upload New Image</h5>
    <input type="file" id="editImage" name="title_image" class="form-control">
</div>
<input type="hidden" name="old_image" id="oldImage">
            <div class="col-md-4">
          <h5>TV Rating</h5>
              <select name="rating" id="editRating" class="form-control">
                <option value="TV-MA">TV-MA</option>
                <option value="TV-14">TV-14</option>
                <option value="TV-PG">TV-PG</option>
                <option value="TV-G">TV-G</option>
                <option value="TV-Y7">TV-Y7</option>
              </select>
            </div>
  
            <div class="col-md-4">
              <h5>Style</h5>
              <select name="style" id="editStyle" class="form-control">
                <option value="2D">2D</option>
                <option value="3D">3D</option>
                <option value="Hybrid">Hybrid</option>
              </select>
            </div>
  
            <div class="col-md-4">
           <h5>Stars</h5>
              <input  name="stars" type="number" id="editStars" min="1" max="5" class="form-control">
            </div>
  
            <div class="col-12">
              <h5>Edit Number of Seasons</h5>
              <input name="num_of_seasons" type="number" id="editSeasons" min="1" class="form-control">
            </div>
  
            <div class="col-12">
              <h5>Edit Summary</h5>
              <textarea name="show_summary" id="editSummary"class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-modal" id="cancelButton" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn-modal" id="saveEditButton">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script>
// Safe empty-check
const isEmpty = (obj) => !obj || Object.keys(obj).length === 0;

// Load table
async function fetchAndRenderAnimeTable(filters = {}) {
  try {
    const qs = !isEmpty(filters) ? ('?' + new URLSearchParams(filters)) : '';
    const response = await fetch('/animeForm' + qs, { method: 'GET' });
    const json = await response.json();
    if (response.status === 200 && json.data) {
      let displayTable = '';
      for (let row of json.data) {
        displayTable +=
          '<tr>' +
            '<td data-label="Title">' + (row.anime_title ?? '') + '</td>' +
            '<td data-label="Date">' + (row.date ?? '') + '</td>' +
            '<td data-label="Rating">' + (row.rating ?? '') + '</td>' +
            '<td data-label="Image">' +
              (row.title_image
                ? '<img src="/uploads/' + row.title_image + '" alt="Anime Image" style="max-width: 100px;">'
                : 'No Image') +
            '</td>' +
            '<td data-label="Style">' + (row.style ?? '') + '</td>' +
            '<td data-label="Summary">' + (row.show_summary ?? '') + '</td>' +
            '<td data-label="Seasons">' + (row.num_of_seasons ?? '') + '</td>' +
            '<td data-label="Stars">' + (row.stars ?? '') + '</td>' +
            '<td data-label="Publisher">' + (row.publisher_name ?? '') + '</td>' +
            '<td data-label="Country">' + (row.country ?? '') + '</td>' +
            '<td data-label="City">' + (row.city ?? '') + '</td>' +
            '<td>' +
              '<button class="editButton" data-id="' + row.anime_id + '">Edit</button>' +
              '<button class="deleteButton" data-id="' + row.anime_id + '">Delete</button>' +
            '</td>' +
          '</tr>';
      }
      document.querySelector('#animeTable tbody').innerHTML = displayTable;
    }
  } catch (error) {
    console.error('Error fetching table data:', error);
  }
}

// Filter
document.getElementById('filterButton').addEventListener('click', () => {
  const p = {};
  if (document.getElementById('filterTitle').value.length !== 0)
    p.title = document.getElementById('filterTitle').value;
  if (document.getElementById('filterDate').value.length !== 0)
    p.date = document.getElementById('filterDate').value;
  if (document.getElementById('filterPublisher').value.length !== 0)
    p.publisher_name = document.getElementById('filterPublisher').value;
  if (document.getElementById('filterRating').value.length !== 0)
    p.rating = document.getElementById('filterRating').value;
  if (document.getElementById('filterStyle').value.length !== 0)
    p.style = document.getElementById('filterStyle').value;
  if (document.getElementById('filterStars').value.length !== 0)
    p.stars = document.getElementById('filterStars').value;

  const limit = document.getElementById('limitRecords').value;
  if (limit) p.limit = limit;

  fetchAndRenderAnimeTable(p);
});

// Clear
document.getElementById('clearButton').addEventListener('click', () => {
  document.getElementById('filterTitle').value = '';
  document.getElementById('filterDate').value = '';
  document.getElementById('filterPublisher').value = '';
  document.getElementById('filterStars').value = '';
  document.getElementById('filterStyle').value = '';
  document.getElementById('filterRating').value = '';
  document.getElementById('limitRecords').value = '10';
  document.getElementById('sortBy').value = 'title';
  fetchAndRenderAnimeTable({});
});

// Sort (server-side via query param)
document.getElementById('sortByInput').addEventListener('click', () => {
  const p = {};
  const limit = document.getElementById('limitRecords').value;
  if (limit) p.limit = limit;

  const t = document.getElementById('filterTitle').value.trim();
  const y = document.getElementById('filterDate').value.trim();
  const pub = document.getElementById('filterPublisher').value.trim();
  const rating = document.getElementById('filterRating').value;
  const style = document.getElementById('filterStyle').value;
  const stars = document.getElementById('filterStars').value;

  if (t) p.title = t;
  if (y) p.date = y;
  if (pub) p.publisher_name = pub;
  if (rating) p.rating = rating;
  if (style) p.style = style;
  if (stars) p.stars = stars;

  p.sortBy = document.getElementById('sortBy').value;
  fetchAndRenderAnimeTable(p);
});

// Initial load
window.addEventListener('DOMContentLoaded', () => {
  fetchAndRenderAnimeTable();
});

// Delete
document.querySelector('#animeTable tbody').addEventListener('click', async (event) => {
  if (event.target.classList.contains('deleteButton')) {
    const animeId = event.target.getAttribute('data-id');
    if (!animeId) return;
    if (!confirm("Are you sure you want to delete this entry?")) return;

    try {
      const response = await fetch(`/animeForm/${animeId}`, { method: 'DELETE' });
      if (response.ok) {
        alert("Entry deleted successfully.");
        fetchAndRenderAnimeTable();
      } else {
        alert("Failed to delete entry.");
      }
    } catch (error) {
      console.error('Error deleting entry:', error);
    }
  }
});

// Edit -> open modal
let currentEditingId = null;
document.querySelector('#animeTable tbody').addEventListener('click', async (event) => {
  if (event.target.classList.contains('editButton')) {
    const animeId = event.target.getAttribute('data-id');
    currentEditingId = animeId;
    try {
      const response = await fetch(`/animeForm/${animeId}`);
      if (response.ok) {
        const animeData = await response.json();
        populateEditForm(animeData.data);
        const modal = new bootstrap.Modal(document.getElementById('editAnimeModal'));
        modal.show();
      } else {
        alert("Failed to fetch data for editing.");
      }
    } catch (error) {
      console.error('Error fetching anime data:', error);
    }
  }
});

// Fill modal fields
function populateEditForm(animeData) {
  document.getElementById('editAnimeId').value = animeData.anime_id ?? '';
  document.getElementById('editTitle').value = animeData.anime_title ?? '';
  document.getElementById('editDate').value = (animeData.date ?? '');
  document.getElementById('editRating').value = animeData.rating ?? 'TV-14';
  document.getElementById('editStyle').value = animeData.style ?? '2D';
  document.getElementById('editSummary').value = animeData.show_summary ?? '';
  document.getElementById('editSeasons').value = animeData.num_of_seasons ?? 1;
  document.getElementById('editStars').value = animeData.stars ?? 1;
  document.getElementById('oldImage').value = animeData.title_image ?? '';
}

// Save edit
document.getElementById('saveEditButton').addEventListener('click', async (e) => {
  e.preventDefault();
  const animeId = document.getElementById('editAnimeId').value;
  const formData = new FormData();
  formData.append('anime_title', document.getElementById('editTitle').value);
  formData.append('date', document.getElementById('editDate').value);
  formData.append('rating', document.getElementById('editRating').value);
  formData.append('style', document.getElementById('editStyle').value);
  formData.append('show_summary', document.getElementById('editSummary').value);
  formData.append('num_of_seasons', document.getElementById('editSeasons').value);
  formData.append('stars', document.getElementById('editStars').value);
  formData.append('old_image', document.getElementById('oldImage').value);
  const imageInput = document.getElementById('editImage');
  if (imageInput.files.length > 0) {
    formData.append('title_image', imageInput.files[0]);
  }

  try {
    const response = await fetch(`/animeForm/${animeId}`, { method: 'PUT', body: formData });
    if (response.ok) {
      alert("Anime entry updated successfully!");
      fetchAndRenderAnimeTable();
      bootstrap.Modal.getInstance(document.getElementById('editAnimeModal')).hide();
    } else {
      const responseData = await response.json().catch(() => ({}));
      displayErrors(responseData.errors || [responseData.message || 'Update failed.']);
    }
  } catch (err) {
    console.error("Update failed:", err);
    displayErrors([{ msg: "An unexpected error occurred." }]);
  }
});

// Banner helpers (uses your existing #banner inside modal)
function displayErrors(errors) {
  const errorContainer = document.getElementById("banner");
  errorContainer.style.backgroundColor = "pink";
  errorContainer.innerHTML = "";
  if (errors && errors.length > 0) {
    errorContainer.innerHTML = "<b>Please fix the following errors:</b><br>";
    errors.forEach(error => {
      const msg = (typeof error === 'string') ? error : (error.msg || JSON.stringify(error));
      const p = document.createElement("p");
      p.classList.add("error-text");
      p.textContent = "- " + msg;
      errorContainer.appendChild(p);
    });
  }
}

function displaySuccessMessage(message) {
  const successContainer = document.getElementById("banner");
  successContainer.innerHTML = "";
  successContainer.style.backgroundColor = "lightgreen";
  successContainer.style.transition = "opacity 0.5s ease-in-out";
  successContainer.style.opacity = "1";
  const successMessage = document.createElement("p");
  successMessage.classList.add("success-text");
  successMessage.textContent = message;
  successContainer.appendChild(successMessage);
  setTimeout(() => {
    successContainer.style.opacity = "0";
    setTimeout(() => {
      successContainer.innerHTML = "";
      successContainer.style.backgroundColor = "";
      successContainer.style.opacity = "1";
    }, 500);
  }, 2000);
}
</script>
